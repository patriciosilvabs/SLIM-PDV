import { useCallback, useEffect } from 'react';
import { PREDEFINED_SOUNDS, SoundType } from './useCustomSounds';
import { usePersistentSettings } from './usePersistentSettings';

interface NotificationSettings {
  enabled: boolean;
  volume: number;
  enabledSounds: Record<SoundType, boolean>;
  selectedSounds: Record<SoundType, string>; // ID of selected sound
  customSoundUrls: Record<SoundType, string>; // URL of the sound to play
}

const defaultSettings: NotificationSettings = {
  enabled: true,
  volume: 0.7,
  enabledSounds: {
    newOrder: true,
    newReservation: true,
    orderReady: true,
    kdsNewOrder: true,
    maxWaitAlert: true,
    tableWaitAlert: true,
    idleTableAlert: true,
    orderCancelled: true,
    bottleneckAlert: true,
    stationChange: true,
    itemDelayAlert: true,
  },
  selectedSounds: {
    newOrder: 'beepClassic',
    newReservation: 'bell',
    orderReady: 'dingDong',
    kdsNewOrder: 'urgentAlert',
    maxWaitAlert: 'urgentAlert',
    tableWaitAlert: 'bell',
    idleTableAlert: 'dingDong',
    orderCancelled: 'urgentAlert',
    bottleneckAlert: 'urgentAlert',
    stationChange: 'bell',
    itemDelayAlert: 'urgentAlert',
  },
  customSoundUrls: {
    newOrder: PREDEFINED_SOUNDS.beepClassic.data,
    newReservation: PREDEFINED_SOUNDS.bell.data,
    orderReady: PREDEFINED_SOUNDS.dingDong.data,
    kdsNewOrder: PREDEFINED_SOUNDS.urgentAlert.data,
    maxWaitAlert: PREDEFINED_SOUNDS.urgentAlert.data,
    tableWaitAlert: PREDEFINED_SOUNDS.bell.data,
    idleTableAlert: PREDEFINED_SOUNDS.dingDong.data,
    orderCancelled: PREDEFINED_SOUNDS.urgentAlert.data,
    bottleneckAlert: PREDEFINED_SOUNDS.urgentAlert.data,
    stationChange: PREDEFINED_SOUNDS.bell.data,
    itemDelayAlert: PREDEFINED_SOUNDS.urgentAlert.data,
  },
};

export function useAudioNotification() {
  // Usar persistência no banco de dados para configurações de áudio
  const { 
    settings, 
    updateSettings: updateSettingsDb,
    setSettings,
  } = usePersistentSettings<NotificationSettings>({
    settingsKey: 'notification_settings',
    defaults: defaultSettings,
    localStorageKey: 'pdv-notification-settings',
  });

  const playSound = useCallback(async (type: SoundType) => {
    if (!settings.enabled || !settings.enabledSounds[type]) return;

    try {
      const soundUrl = settings.customSoundUrls[type] || PREDEFINED_SOUNDS.beepClassic.data;
      const audio = new Audio(soundUrl);
      audio.volume = settings.volume;
      await audio.play();
    } catch (error) {
      console.warn('Could not play notification sound:', error);
    }
  }, [settings]);

  const playNewOrderSound = useCallback(() => playSound('newOrder'), [playSound]);
  const playNewReservationSound = useCallback(() => playSound('newReservation'), [playSound]);
  const playOrderReadySound = useCallback(() => playSound('orderReady'), [playSound]);
  const playKdsNewOrderSound = useCallback(() => playSound('kdsNewOrder'), [playSound]);
  const playMaxWaitAlertSound = useCallback(() => playSound('maxWaitAlert'), [playSound]);
  const playTableWaitAlertSound = useCallback(() => playSound('tableWaitAlert'), [playSound]);
  const playIdleTableAlertSound = useCallback(() => playSound('idleTableAlert'), [playSound]);
  const playOrderCancelledSound = useCallback(() => playSound('orderCancelled'), [playSound]);
  const playBottleneckAlertSound = useCallback(() => playSound('bottleneckAlert'), [playSound]);
  const playStationChangeSound = useCallback(() => playSound('stationChange'), [playSound]);
  const playItemDelayAlertSound = useCallback(() => playSound('itemDelayAlert'), [playSound]);

  const updateSettings = useCallback((updates: Partial<NotificationSettings>) => {
    updateSettingsDb(updates);
  }, [updateSettingsDb]);

  const toggleSound = useCallback((type: SoundType) => {
    setSettings({
      ...settings,
      enabledSounds: {
        ...settings.enabledSounds,
        [type]: !settings.enabledSounds[type],
      },
    });
  }, [settings, setSettings]);

  const setSelectedSound = useCallback((type: SoundType, soundId: string, soundUrl: string) => {
    setSettings({
      ...settings,
      selectedSounds: {
        ...settings.selectedSounds,
        [type]: soundId,
      },
      customSoundUrls: {
        ...settings.customSoundUrls,
        [type]: soundUrl,
      },
    });
  }, [settings, setSettings]);

  const testSound = useCallback((type: SoundType) => {
    const soundUrl = settings.customSoundUrls[type] || PREDEFINED_SOUNDS.beepClassic.data;
    const audio = new Audio(soundUrl);
    audio.volume = settings.volume;
    audio.play().catch(console.warn);
  }, [settings.customSoundUrls, settings.volume]);

  return {
    settings,
    updateSettings,
    toggleSound,
    setSelectedSound,
    testSound,
    playSound,
    playNewOrderSound,
    playNewReservationSound,
    playOrderReadySound,
    playKdsNewOrderSound,
    playMaxWaitAlertSound,
    playTableWaitAlertSound,
    playIdleTableAlertSound,
    playOrderCancelledSound,
    playBottleneckAlertSound,
    playStationChangeSound,
    playItemDelayAlertSound,
  };
}
